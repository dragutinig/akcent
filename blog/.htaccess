(cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF'
diff --git a/blog/.htaccess b/blog/.htaccess
index 5b0b86f2c26aab28b23e3d193109505b9d23c9cf..52afb41d38fd25396ab8c8299c9d58b757cb53f5 100644
--- a/blog/.htaccess
+++ b/blog/.htaccess
@@ -1,43 +1,53 @@

# Omogućavanje mod_rewrite

 <IfModule mod_rewrite.c>
     RewriteEngine On
-    RewriteBase /blog/
-
     # Redirektuj /admin na /blog/php/dashboard.php
     RewriteRule ^admin$ php/dashboard.php [L,R=302]
 
+    # Blog početna bez /php/ u URL-u
+    RewriteRule ^$ php/index.php [L]
+
+    # Kanonski preusmeri /php na blog root (radi i na podfolderima)
+    RewriteRule ^php/?$ ./ [R=301,L]
+
+    # Blokiraj ghost URL-ove koji završavaju na .php van /blog/php/
+    RewriteCond %{REQUEST_URI} !/blog/php/ [NC]
+    RewriteRule \.php$ - [R=404,L]
+
     # Preusmeravanje za postove: /category/slug/
+    # Dopuštamo samo SEO slug format (a-z, 0-9, -)
     RewriteCond %{REQUEST_FILENAME} !-f
     RewriteCond %{REQUEST_FILENAME} !-d
-    RewriteRule ^([^/]+)/([^/]+)/?$ php/post.php?category=$1&slug=$2 [L,QSA]
+    RewriteRule ^([a-z0-9-]+)/([a-z0-9-]+)/?$ php/post.php?category=$1&slug=$2 [L,QSA,NC]
 
     # Preusmeravanje za kategorije: /slug/
     RewriteCond %{REQUEST_FILENAME} !-f
     RewriteCond %{REQUEST_FILENAME} !-d
-    RewriteRule ^([^/]+)/?$ php/category.php?slug=$1 [L,QSA]
+    RewriteRule ^([a-z0-9-]+)/?$ php/category.php?slug=$1 [L,QSA,NC]
 
     # Omogućavanje simboličkih linkova
     Options +FollowSymlinks
 
     # Detekcija protokola, ali bez forsiranja HTTPS-a
     RewriteCond %{HTTPS} =on
     RewriteRule ^ - [env=proto:https]
     RewriteCond %{HTTPS} !=on
     RewriteRule ^ - [env=proto:http]
 
-    # Preusmeravanje svih HTTP zahteva na HTTPS
+    # Preusmeravanje na HTTPS samo van localhost okruženja
+    RewriteCond %{HTTP_HOST} !^(localhost|127\.0\.0\.1)$ [NC]
     RewriteCond %{HTTPS} off
     RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
 </IfModule>
 
 # Sprečavanje indeksiranja direktorijuma
 Options -Indexes
 
 # Blokiranje pristupa osetljivim fajlovima
 <FilesMatch "\.(htaccess|htpasswd|ini|log|env)">
     Order allow,deny
     Deny from all
 </FilesMatch>
 
-# Content-Security-Policy (CSP) - omogućava učitavanje resursa sa samog domena, CDN-a i omogućava inline skripte i stilove
-Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://code.jquery.com https://stackpath.bootstrapcdn.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://stackpath.bootstrapcdn.com https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self'; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';"
+# Content-Security-Policy (CSP)
+Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://code.jquery.com https://stackpath.bootstrapcdn.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://stackpath.bootstrapcdn.com https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' https: data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';"
 
EOF
)
